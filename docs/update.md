# Update Percona Operator for PostgreSQL

Percona Operator for PostgreSQL allows upgrades to newer versions.
The upgradable components of the cluster are
the following ones:

* the Operator;
* [Custom Resource Definition (CRD)](operator.md),
* Database Management System (Percona Distribution for PostgreSQL).

## Upgrading the Operator

Only the incremental update to a nearest minor version of the Operator is
supported. To update to a newer version, which differs from the current
version by more than one, make several incremental updates sequentially.

The following steps will allow you to update the Operator to current version
(use the name of your cluster instead of the `<cluster-name>` placeholder).

1. Pause the cluster in order to stop all possible activities:

    ``` {.bash data-prompt="$" }
    $ kubectl patch perconapgcluster/<cluster-name> --type json -p '[{"op": "replace", "path": "/spec/pause", "value": true},{"op":"replace","path":"/spec/pgBouncer/size","value":0}]'
    ```

2. If you upgrade the Operator **from a version earlier than 1.1.0**, the
following additional step is needed for the 1.0.0 → 1.1.0 upgrade.

    ``` {.bash data-prompt="$" }
    $ export CLUSTER=<cluster-name>
    $ for user in postgres primaryuser $(kubectl get perconapgcluster/${CLUSTER} -o yaml | yq r - 'spec.user'); do args+="--from-literal=$user=$(kubectl get secret/${CLUSTER}-${user}-o yaml | yq r - 'data.password' | base64 --decode) "; done; eval kubectl create secret generic ${CLUSTER}-users "${args}"
    ```

    This command creates users’ secrets with existing passwords. Otherwise, new
    secrets with autogenerated passwords will be created automatically,
    so existing passwords will be overwritten.

    !!! note

        The `pgbouncer` user password is stored in encrypted form, and
        therefore it is not included in the above command. If you know this
        password and/or would like to update it, please add it as
        `pgbouncer: base64encodednewpassword` to the resulted Secret manually.
        Otherwise, this password needs no actions and will be overwritten by the
        Operator during upgrade.

3. Remove the old Operator and start the new Operator version:

    ``` {.bash data-prompt="$" }
    $ kubectl delete \
        serviceaccounts/pgo-deployer-sa \
        clusterroles/pgo-deployer-cr \
        configmaps/pgo-deployer-cm \
        configmaps/pgo-config \
        clusterrolebindings/pgo-deployer-crb \
        jobs.batch/pgo-deploy \
        deployment/postgres-operator

    $ kubectl create -f https://raw.githubusercontent.com/percona/percona-postgresql-operator/v{{ release }}/deploy/operator.yaml
    $ kubectl wait --for=condition=Complete job/pgo-deploy --timeout=90s
    ```

## Upgrading Percona Distribution for PostgreSQL

### Semi-automatic upgrade

Semi-automatic update of Percona Distribution for PostgreSQL should be used with the Operator
version 1.0.0 or earlier. For all newer versions, use automatic update
instead.

The following steps will allow you to update the Operator to current version
(use the name of your cluster instead of the `<cluster-name>` placeholder).


1. Pause the cluster in order to stop all possible activities:

    ``` {.bash data-prompt="$" }
    $ kubectl patch perconapgcluster/<cluster-name> --type json -p '[{"op": "replace", "path": "/spec/pause", "value": true},{"op":"replace","path":"/spec/pgBouncer/size","value":0}]'
    ```

2. Now you can switch the cluster to a new version:

    ``` {.bash data-prompt="$" }
    $ kubectl patch perconapgcluster/<cluster-name> --type json -p '[{"op": "replace", "path": "/spec/backup/backrestRepoImage", "value": "percona/percona-postgresql-operator:{{ release }}-ppg14-pgbackrest-repo"},{"op":"replace","path":"/spec/backup/image","value":"percona/percona-postgresql-operator:{{ release }}-ppg13-pgbackrest"},{"op":"replace","path":"/spec/pgBadger/image","value":"percona/percona-postgresql-operator:{{ release }}-ppg14-pgbadger"},{"op":"replace","path":"/spec/pgBouncer/image","value":"percona/percona-postgresql-operator:{{ release }}-ppg14-pgbouncer"},{"op":"replace","path":"/spec/pgPrimary/image","value":"percona/percona-postgresql-operator:{{ release }}-ppg14-postgres-ha"},{"op":"replace","path":"/spec/userLabels/pgo-version","value":"v{{ release }}"},{"op":"replace","path":"/metadata/labels/pgo-version","value":"v{{ release }}"},{"op": "replace", "path": "/spec/pause", "value": false}]'
    ```

    !!! note

        The above example is composed in asumption of using PostgreSQL 14 as
        a database management system. For PostgreSQL 13 you should change all
        occurrences of the `ppg14` substring to `ppg13`.

    This will carry on the image update, cluster version update and the pause status
    switch.

3. Now you can enable the `pgbouncer` again:

    ``` {.bash data-prompt="$" }
    $ kubectl patch perconapgcluster/<cluster-name --type json -p \
        '[
            {"op":"replace","path":"/spec/pgBouncer/size","value":1}
        ]'
    ```

    Wait until the cluster is ready.
